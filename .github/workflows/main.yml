name: Subconverter Filter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

# Исправляем 403 Forbidden
permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Subconverter
        run: |
          # Исправленная ссылка на скачивание архива
          wget -O subconverter_linux64.tar.gz https://github.com
          tar -xzf subconverter_linux64.tar.gz
          echo "Subconverter установлен"

      - name: Проверяем исходный файл
        run: |
          echo "Используем исходный файл: VlessLinks.txt"
          # Фильтруем vless и reality, сохраняем во временный файл
          grep -iE 'vless://|reality://' VlessLinks.txt > VlessLinks_filtered.txt || true
          echo "Фильтрация завершена"

      - name: Generate Clash Config
        run: |
          # Переносим отфильтрованные ссылки в итоговый файл без лишних заголовков
          if [ -s VlessLinks_filtered.txt ]; then
            cat VlessLinks_filtered.txt > all_proxies.yaml
          else
            echo "Внимание: Фильтр ничего не нашел!"
            touch all_proxies.yaml
          fi

      - name: Commit and Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add all_proxies.yaml
          # Проверка на наличие изменений
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update proxies $(date)"
            git push
          fi

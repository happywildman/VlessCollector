name: Build Clash Proxies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Clash YAML
        run: |
          set -e

          SOURCE_FILE="VlessLinks.txt"
          OUTPUT_FILE="all_proxies.yaml"

          if [ ! -f "$SOURCE_FILE" ]; then
            echo "VlessLinks.txt not found"
            exit 1
          fi

          rm -f "$OUTPUT_FILE" temp.txt

          echo "proxies:" > "$OUTPUT_FILE"

          grep -E '^vless://' "$SOURCE_FILE" | grep -v "tls" | sort -u > temp.txt

          while IFS= read -r line || [ -n "$line" ]; do
            url=$(echo "$line" | tr -d '\r' | xargs)

            if [[ "$url" =~ ^vless://([^@]+)@([^:]+):([0-9]+)\?([^#]+)#?(.*)$ ]]; then
              UUID="${BASH_REMATCH[1]}"
              SERVER="${BASH_REMATCH[2]}"
              PORT="${BASH_REMATCH[3]}"
              QUERY="${BASH_REMATCH[4]}"
              NAME="${BASH_REMATCH[5]}"

              TYPE=$(echo "$QUERY" | grep -oP 'type=\K[^&]*' || echo "tcp")
              FLOW=$(echo "$QUERY" | grep -oP 'flow=\K[^&]*' || echo "")
              SECURITY=$(echo "$QUERY" | grep -oP 'security=\K[^&]*' || echo "")
              SNI=$(echo "$QUERY" | grep -oP 'sni=\K[^&]*' || echo "")
              FP=$(echo "$QUERY" | grep -oP 'fp=\K[^&]*' || echo "")
              HOST=$(echo "$QUERY" | grep -oP 'host=\K[^&]*' || echo "")
              PATH=$(echo "$QUERY" | grep -oP 'path=\K[^&]*' || echo "")

              echo "  - name: \"${NAME:-${SERVER}}\"" >> "$OUTPUT_FILE"
              echo "    type: vless" >> "$OUTPUT_FILE"
              echo "    server: ${SERVER}" >> "$OUTPUT_FILE"
              echo "    port: ${PORT}" >> "$OUTPUT_FILE"
              echo "    uuid: ${UUID}" >> "$OUTPUT_FILE"
              echo "    udp: true" >> "$OUTPUT_FILE"

              if [ -n "$TYPE" ]; then
                echo "    network: ${TYPE}" >> "$OUTPUT_FILE"
              fi

              if [ "$SECURITY" = "reality" ]; then
                echo "    tls: true" >> "$OUTPUT_FILE"
              fi

              if [ -n "$SNI" ]; then
                echo "    sni: ${SNI}" >> "$OUTPUT_FILE"
              fi

              if [ -n "$FLOW" ]; then
                echo "    flow: ${FLOW}" >> "$OUTPUT_FILE"
              fi

              if [ -n "$HOST" ]; then
                echo "    host: ${HOST}" >> "$OUTPUT_FILE"
              fi

              if [ -n "$PATH" ]; then
                echo "    path: ${PATH}" >> "$OUTPUT_FILE"
              fi
            fi
          done < temp.txt

          rm -f temp.txt

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add all_proxies.yaml
          git commit -m "Update proxies" || exit 0
          git push

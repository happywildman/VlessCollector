- name: Generate Clash.yaml from all_proxies.yaml
  run: |
    set -e
    python3 <<EOF
import yaml
import re
from urllib.parse import urlparse, parse_qs, unquote

with open('all_proxies.yaml', 'r') as f:
    data = yaml.safe_load(f)

clash_proxies = []

for item in data['proxies']:
    url = item.strip()[2:]  # убираем "  - "
    if not url.startswith("vless://"):
        continue
    parsed = urlparse(url)
    uuid = unquote(parsed.username) if parsed.username else ''
    server = parsed.hostname
    port = int(parsed.port) if parsed.port else 0
    query = parse_qs(parsed.query)
    net_type = query.get('type', ['tcp'])[0]
    path = query.get('path', [''])[0]
    host = query.get('host', [''])[0]

    proxy = {
        'name': f"{server}-{port}",
        'type': 'vless',
        'server': server,
        'port': port,
        'uuid': uuid,
        'network': net_type,
        'tls': 'tls' in query,
        'udp': True
    }

    if net_type == 'ws':
        proxy['ws-opts'] = {
            'path': path,
            'headers': {
                'Host': host
            }
        }

    clash_proxies.append(proxy)

with open('clash.yaml', 'w') as f:
    yaml.dump({'proxies': clash_proxies}, f, allow_unicode=True, sort_keys=False)
EOF

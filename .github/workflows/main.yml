name: Subconverter Workflow

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List files before processing
        run: ls -la

      - name: Filter only VLESS and REALITY links
        run: |
          echo "Проверяем исходный файл..."
          if [ -f raw.txt ]; then
            INPUT_FILE="raw.txt"
          elif [ -f VlessLinks.txt ]; then
            INPUT_FILE="VlessLinks.txt"
          else
            echo "Ошибка: исходный файл не найден!"
            exit 1
          fi
          echo "Используем файл: $INPUT_FILE"
          grep -iE 'vless://|reality://' "$INPUT_FILE" > raw_filtered.txt
          echo "Количество отобранных ссылок:"
          wc -l raw_filtered.txt

      - name: Run Subconverter Docker
        run: |
          docker run --rm -v "${PWD}:/base" tindy2013/subconverter \
          -i /base/raw_filtered.txt \
          -o /base/all_proxies.yaml \
          -f clash

      - name: List output
        run: ls -la

      # ===== ШАГ 3: ТРАФИК ТЕСТ (ПАРАЛЛЕЛЬНО) → traff.yaml =====
      - name: Traffic test - create traff.yaml
        run: |
          set -e
          echo "Starting TRAFFIC TEST at $(date)"
          
          # Функция декодирования
          urldecode() {
            local data="$1"
            decoded=$(echo "$data" | sed 's/%/\\x/g' | xargs -0 printf "%b" 2>/dev/null || echo "$data")
            echo "$decoded"
          }
          
          echo "proxies:" > traff.yaml
          
          # Создаем директорию для временных файлов
          mkdir -p /tmp/traffic_results
          rm -f /tmp/traffic_results/*
          
          # Собираем прокси для трафик теста
          > /tmp/traffic_servers.txt
          > /tmp/traffic_ports.txt
          > /tmp/traffic_lines.txt
          
          total=0
          
          while IFS= read -r line || [ -n "$line" ]; do
            [[ "$line" == "proxies:" ]] && continue
            [[ -z "$line" ]] && continue
            
            url="${line#  - }"
            
            # Парсим сервер и порт
            server_port=$(echo "$url" | sed -n 's#vless://[^@]*@\([^?#]*\).*#\1#p')
            server=$(echo "$server_port" | cut -d: -f1)
            port=$(echo "$server_port" | cut -d: -f2 | grep -E '^[0-9]+$' || true)
            
            if [ -z "$server" ] || [ -z "$port" ]; then
              continue
            fi
            
            total=$((total + 1))
            
            echo "$server" >> /tmp/traffic_servers.txt
            echo "$port" >> /tmp/traffic_ports.txt
            echo "$line" >> /tmp/traffic_lines.txt
            
          done < ping.yaml
          
          echo "Total proxies for traffic test: $total"
          echo "Starting parallel traffic test (10 at a time)..."
          
          # Функция для проверки трафика
          traffic_proxy() {
            local idx=$1
            local server=$(sed -n "${idx}p" /tmp/traffic_servers.txt)
            local port=$(sed -n "${idx}p" /tmp/traffic_ports.txt)
            local line=$(sed -n "${idx}p" /tmp/traffic_lines.txt)
            
            # Проверка трафика через прокси
            if curl --socks5-hostname "$server:$port" \
                    -s -o /dev/null -w "%{http_code}" \
                    --max-time 5 \
                    "http://www.gstatic.com/generate_204" 2>/dev/null | grep -q "204"; then
              echo "$line" >> "/tmp/traffic_results/passed_${idx}.txt"
              echo "✅ $server:$port - passed"
            else
              echo "❌ $server:$port - failed"
            fi
          }
          
          export -f traffic_proxy
          
          # Запускаем параллельно (10 потоков)
          seq 1 $total | xargs -P 10 -I {} bash -c 'traffic_proxy "$@"' _ {}
          
          # Собираем все успешные результаты
          if [ -d /tmp/traffic_results ]; then
            cat /tmp/traffic_results/*.txt >> traff.yaml 2>/dev/null || true
          fi
          
          passed_count=$(grep -c '^-' traff.yaml || echo 0)
          
          echo ""
          echo "=== TRAFFIC TEST RESULTS ==="
          echo "Total tested: $total"
          echo "✅ Passed traffic: $passed_count"
          echo "❌ Failed traffic: $((total - passed_count))"
          
          rm -rf /tmp/traffic_servers.txt /tmp/traffic_ports.txt /tmp/traffic_lines.txt /tmp/traffic_results

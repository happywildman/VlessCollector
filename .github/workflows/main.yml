name: Subconverter Vless Reality Filtered
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pyyaml

      - name: Install Subconverter
        run: |
          ASSET_URL=$(curl -s https://api.github.com/repos/tindy2013/subconverter/releases/latest \
                      | grep "browser_download_url.*linux64.tar.gz" | cut -d '"' -f 4)
          curl -L -o subconverter.tar.gz "$ASSET_URL"
          tar -xzf subconverter.tar.gz
          chmod +x subconverter/subconverter

      - name: Generate and Clean Vless Reality Nodes
        run: |
          # Проверка VlessLinks.txt
          if [[ ! -f VlessLinks.txt ]]; then
            echo "VlessLinks.txt not found"
            exit 1
          fi

          RAW_URLS=$(grep -v '^#' VlessLinks.txt | grep -v '^$' | tr -d '\r' | tr '\n' '|' | sed 's/|$//')
          if [[ -z "$RAW_URLS" ]]; then
            echo "No URLs found in VlessLinks.txt"
            exit 1
          fi

          # Запуск Subconverter
          ./subconverter/subconverter &

          # Ожидание порта
          TIMEOUT=20
          while ! nc -z 127.0.0.1 25500; do
            sleep 1
            TIMEOUT=$((TIMEOUT-1))
            if [[ $TIMEOUT -le 0 ]]; then
              echo "Subconverter did not start in time"
              exit 1
            fi
          done

          # Получение raw_clash.yaml
          curl -s -G "http://127.0.0.1:25500/sub" \
               --data-urlencode "target=clash" \
               --data-urlencode "url=${RAW_URLS}" \
               --data-urlencode "emoji=true" \
               -o raw_clash.yaml

          if [[ ! -f raw_clash.yaml ]] || [[ ! -s raw_clash.yaml ]]; then
            echo "raw_clash.yaml is empty or missing"
            exit 1
          fi

          # Python-скрипт для фильтрации Reality/Vless узлов
          python3 <<'EOF'
import re
import yaml

RAW_FILE = "raw_clash.yaml"
OUT_FILE = "clash_config.yaml"

def sanitize_name(name):
    name = re.split(r'[|/@—]', str(name))[0].strip()
    name = re.sub(r'http\S+|www\S+|\.com|\.net|t\.me\S+|@[a-zA-Z0-9_]+', '', name, flags=re.IGNORECASE)
    name = "".join(c for c in name if c.isalnum() or c in " .-_()").strip()
    return name if len(name) > 1 else "Vless-Server"

with open(RAW_FILE, 'r', encoding='utf-8', errors='ignore') as f:
    content = f.read()

# Вытаскиваем секцию proxies через regex
proxies_raw_match = re.search(r'proxies:\s*(\[[\s\S]*?\])', content)
if not proxies_raw_match:
    print("No proxies section found")
    exit(1)

proxies_raw = proxies_raw_match.group(1)

try:
    proxy_list = yaml.safe_load(proxies_raw)
except:
    print("Proxy list parsing failed")
    exit(1)

cleaned = []
names = set()
server_port_seen = set()

for proxy in proxy_list:
    try:
        if proxy.get('type','').lower() != 'vless':
            continue

        server = proxy.get('server')
        port = proxy.get('port')
        if not server or not port:
            continue

        # Reality check: хотя бы один ключ специфичный для Reality
        if not any(k in proxy for k in ['uuid', 'id', 'flow', 'ws-path']):
            continue

        # Убираем дубликаты server:port
        key = f"{server}:{port}"
        if key in server_port_seen:
            continue
        server_port_seen.add(key)

        old_name = proxy.get('name','Vless-Server')
        new_name = sanitize_name(old_name)

        final_name = new_name
        i = 1
        while final_name in names:
            final_name = f"{new_name}-{i}"
            i += 1

        proxy['name'] = final_name
        names.add(final_name)
        cleaned.append(proxy)

    except:
        continue

final_yaml = {
    'proxies': cleaned,
    'proxy-groups': [
        {
            'name': 'PROXY',
            'type': 'select',
            'proxies': list(names) if names else ['DIRECT']
        }
    ],
    'rules': ['MATCH,PROXY']
}

with open(OUT_FILE, 'w', encoding='utf-8') as f:
    yaml.safe_dump(final_yaml, f, allow_unicode=True, sort_keys=False)

print(f"Valid Vless Reality nodes: {len(cleaned)}")
EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [[ -f "clash_config.yaml" ]]; then
            git add clash_config.yaml
            git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Vless Reality $(date +%H:%M)" && git push)

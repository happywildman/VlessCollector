name: Build Clash Proxies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and Extract VLESS
        run: |
          set -e

          SOURCE_FILE="VlessLinks.txt"
          OUTPUT_RAW="raw_links.txt"
          OUTPUT_FILE="all_proxies.yaml"

          rm -f "$OUTPUT_RAW" "$OUTPUT_FILE"

          touch "$OUTPUT_RAW"

          while IFS= read -r url || [ -n "$url" ]; do
            clean_url=$(echo "$url" | tr -d '\r' | xargs)
            [ -z "$clean_url" ] && continue

            echo "Downloading $clean_url"

            content=$(curl -fsSL --max-time 20 "$clean_url" || true)

            # Проверка base64
            if echo "$content" | grep -qv "vless://"; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null || true)
              echo "$decoded" >> "$OUTPUT_RAW"
            else
              echo "$content" >> "$OUTPUT_RAW"
            fi

            echo "" >> "$OUTPUT_RAW"
          done < "$SOURCE_FILE"

          # Оставляем только vless строки
          grep -oE 'vless://[^[:space:]]+' "$OUTPUT_RAW" | sort -u > clean_vless.txt

      - name: Convert to Clash YAML
        run: |
          set -e

          echo "proxies:" > all_proxies.yaml

          while IFS= read -r url || [ -n "$url" ]; do
            if [[ "$url" =~ ^vless://([^@]+)@([^:]+):([0-9]+)\?([^#]+)#?(.*)$ ]]; then
              UUID="${BASH_REMATCH[1]}"
              SERVER="${BASH_REMATCH[2]}"
              PORT="${BASH_REMATCH[3]}"
              QUERY="${BASH_REMATCH[4]}"
              NAME="${BASH_REMATCH[5]}"

              TYPE=$(echo "$QUERY" | grep -oP 'type=\K[^&]*' || echo "tcp")
              SECURITY=$(echo "$QUERY" | grep -oP 'security=\K[^&]*' || echo "")
              SNI=$(echo "$QUERY" | grep -oP 'sni=\K[^&]*' || echo "")

              echo "  - name: \"${NAME:-$SERVER}\"" >> all_proxies.yaml
              echo "    type: vless" >> all_proxies.yaml
              echo "    server: $SERVER" >> all_proxies.yaml
              echo "    port: $PORT" >> all_proxies.yaml
              echo "    uuid: $UUID" >> all_proxies.yaml
              echo "    udp: true" >> all_proxies.yaml

              if [ "$TYPE" = "ws" ]; then
                echo "    network: ws" >> all_proxies.yaml
              else
                echo "    network: tcp" >> all_proxies.yaml
              fi

              if [ "$SECURITY" = "reality" ] || [ "$SECURITY" = "tls" ]; then
                echo "    tls: true" >> all_proxies.yaml
              fi

              if [ -n "$SNI" ]; then
                echo "    sni: $SNI" >> all_proxies.yaml
              fi
            fi
          done < clean_vless.txt

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add all_proxies.yaml
          git commit -m "Update proxies" || exit 0
          git push

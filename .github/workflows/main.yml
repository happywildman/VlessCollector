name: Subconverter Filter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Subconverter
        run: |
          # Используем curl с флагом -L для корректной обработки редиректов GitHub
          curl -L -o subconverter_linux64.tar.gz https://github.com
          
          # Проверка: если файл - это HTML, значит скачивание не удалось
          if file subconverter_linux64.tar.gz | grep -q 'HTML'; then
            echo "Ошибка: Скачан HTML вместо архива. Пробуем альтернативный метод."
            rm subconverter_linux64.tar.gz
            curl -L -o subconverter_linux64.tar.gz "https://github.com"
          fi
          
          tar -xzf subconverter_linux64.tar.gz
          echo "Subconverter распакован успешно"

      - name: Filter and Format for Clash
        run: |
          echo "Используем исходный файл: VlessLinks.txt"
          
          # 1. Фильтруем только нужные протоколы
          grep -iE 'vless://|reality://' VlessLinks.txt > filtered.txt || true
          
          # 2. Создаем валидный YAML формат, который Clash съест БЕЗ конвертера
          # Это решает проблему 'cannot unmarshal'
          echo "proxies:" > all_proxies.yaml
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              # Убираем возможные лишние пробелы и оборачиваем в кавычки
              clean_line=$(echo "$line" | xargs)
              echo "  - \"$clean_line\"" >> all_proxies.yaml
            fi
          done < filtered.txt
          
          echo "Файл all_proxies.yaml сформирован. Найдено узлов: $(grep -c '  - ' all_proxies.yaml)"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all_proxies.yaml
          
          if git diff --cached --quiet; then
            echo "Изменений нет"
          else
            git commit -m "Update proxies: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

name: Subconverter Filter Optimized

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Subconverter
        run: |
          ASSET_URL=$(curl -s https://api.github.com/repos/tindy2013/subconverter/releases/latest | grep "browser_download_url.*linux64.tar.gz" | cut -d '"' -f 4)
          curl -L -o subconverter.tar.gz "$ASSET_URL"
          tar -xzf subconverter.tar.gz

      - name: Generate Clash Config
        run: |
          # 1. Проверка ссылок
          if [[ ! -s "VlessLinks.txt" ]]; then echo "VlessLinks.txt is empty"; exit 1; fi

          # 2. Подготовка ссылок (кодируем в Base64 для безопасной передачи серверу)
          # Subconverter лучше всего понимает ссылки, когда они приходят в одном запросе
          RAW_LINKS=$(cat VlessLinks.txt | tr '\n' '|' | sed 's/|$//')
          
          # 3. Запуск Subconverter в режиме сервера
          cd subconverter
          chmod +x subconverter
          ./subconverter & # Запуск в фоне
          
          # Ждем пару секунд, пока сервер поднимется
          sleep 3
          
          # 4. Запрос конвертации через локальный API
          # Мы передаем ссылки через параметр 'url' и просим формат 'clash'
          echo "Sending conversion request..."
          curl -s "http://127.0.0.1:25500/sub?target=clash&url=${RAW_LINKS}&insert=false" -o clash_config_raw.yaml
          
          # 5. Проверка результата
          if grep -q "proxies:" clash_config_raw.yaml; then
            echo "SUCCESS: Clash config generated."
            cp clash_config_raw.yaml ../clash_config.yaml
          else
            echo "ERROR: Generation failed. Server response:"
            cat clash_config_raw.yaml
            exit 1
          fi
          cd ..

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -f "clash_config.yaml" ]]; then
            git add clash_config.yaml
            if git diff --cached --quiet; then
              echo "No changes"
            else
              git commit -m "Update Clash Config: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
              git push
            fi
          fi

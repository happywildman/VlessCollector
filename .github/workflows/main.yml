name: Subconverter VLESS & REALITY Filter

on:
  workflow_dispatch:

jobs:
  filter_and_convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Docker
        uses: docker/setup-buildx-action@v2

      - name: Verify input file
        run: |
          echo "Проверяем наличие исходного файла..."
          if [ -f raw.txt ]; then
            INPUT_FILE="raw.txt"
          elif [ -f VlessLinks.txt ]; then
            INPUT_FILE="VlessLinks.txt"
          else
            echo "Ошибка: исходный файл не найден!"
            exit 1
          fi
          echo "Используем файл: $INPUT_FILE"

      - name: Filter only VLESS and REALITY links
        run: |
          grep -iE 'vless://|reality://' "$INPUT_FILE" > raw_filtered.txt
          echo "Количество отобранных ссылок:"
          wc -l raw_filtered.txt

      - name: Run Subconverter Docker
        run: |
          echo "Запуск Subconverter..."
          docker run --rm -v "${PWD}:/base" tindy2013/subconverter \
            -i /base/raw_filtered.txt \
            -o /base/all_proxies.yaml \
            -f yaml
          echo "Subconverter завершен. Выходной файл: all_proxies.yaml"

      - name: Show filtered sample
        run: |
          echo "Первые 10 строк отфильтрованных ссылок:"
          head -n 10 raw_filtered.txt

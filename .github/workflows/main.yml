name: Collect Proxies

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect and Strict Clean Vless
        run: |
          set -e

          SOURCE_FILE="VlessLinks.txt"

          if [ ! -f "$SOURCE_FILE" ]; then
            echo "VlessLinks.txt not found"
            exit 1
          fi

          rm -f all_proxies.yaml temp.txt

          echo "proxies:" > all_proxies.yaml

          while IFS= read -r url || [ -n "$url" ]; do
            clean_url=$(echo "$url" | tr -d '\r' | xargs)
            [[ -z "$clean_url" || "$clean_url" == \#* ]] && continue
            curl -fsSL --max-time 15 "$clean_url" >> temp.txt || true
            echo "" >> temp.txt
          done < "$SOURCE_FILE"

          sed -i 's/vless:/\nvless:/g' temp.txt

          grep -oE 'vless://[^[:space:]]+' temp.txt \
            | grep -v "%25" \
            | grep -E 'vless://[^@]+@[^:]+:[0-9]+' \
            | grep -v "127.0.0.1" \
            | grep -v "ðŸ”’" \
            | grep -v "tls" \
            | grep -v " " \
            | awk 'length($0) > 40 && length($0) < 1200' \
            | sort -u \
            | head -n 30000 \
            | sed 's/^/  - /' >> all_proxies.yaml

          rm -f temp.txt

      - name: Generate Clash Config
        run: |
          set -e

          RAW="all_proxies.yaml"
          OUT="clash.yaml"

          echo "proxies:" > "$OUT"

          if ! grep -q '^  - vless://' "$RAW"; then
            echo "No valid VLESS entries found."
            exit 0
          fi

          while IFS= read -r line; do

            link="${line#  - }"
            [ -z "$link" ] && continue

            base="${link%%#*}"
            clean="${base#vless://}"

            uuid="${clean%%@*}"
            rest="${clean#*@}"
            host_port="${rest%%\?*}"

            if [[ "$host_port" =~ \[(.*)\]:(.*) ]]; then
              server="${BASH_REMATCH[1]}"
              port="${BASH_REMATCH[2]}"
            else
              server="${host_port%%:*}"
              port="${host_port##*:}"
            fi

            params=""
            [[ "$rest" == *\?* ]] && params="${rest#*\?}"

            network="tcp"
            tls="false"
            host=""
            path=""
            sni=""
            pbk=""
            sid=""
            fp=""

            IFS='&' read -ra kv <<< "$params"
            for pair in "${kv[@]}"; do
              key="${pair%%=*}"
              val="${pair#*=}"

              case "$key" in
                type) network="$val" ;;
                security) [ "$val" = "tls" ] && tls="true"
                          [ "$val" = "reality" ] && tls="true" ;;
                host) host="$val" ;;
                path) path="$val" ;;
                sni) sni="$val" ;;
                pbk) pbk="$val" ;;
                sid) sid="$val" ;;
                fp) fp="$val" ;;
              esac
            done

            name="${server}-${port}"

            {
              echo "  - name: \"$name\""
              echo "    type: vless"
              echo "    server: \"$server\""
              echo "    port: $port"
              echo "    uuid: \"$uuid\""
              echo "    network: \"$network\""
              echo "    tls: $tls"
              echo "    udp: true"
            } >> "$OUT"

            if [ "$network" = "ws" ]; then
              echo "    ws-opts:" >> "$OUT"
              [ -n "$path" ] && echo "      path: \"$path\"" >> "$OUT"
              if [ -n "$host" ]; then
                echo "      headers:" >> "$OUT"
                echo "        Host: \"$host\"" >> "$OUT"
              fi
            fi

            if [ -n "$sni" ]; then
              echo "    servername: \"$sni\"" >> "$OUT"
            fi

            if [ -n "$pbk" ]; then
              echo "    reality-opts:" >> "$OUT"
              echo "      public-key: \"$pbk\"" >> "$OUT"
              [ -n "$sid" ] && echo "      short-id: \"$sid\"" >> "$OUT"
              [ -n "$fp" ] && echo "      fingerprint: \"$fp\"" >> "$OUT"
            fi

          done < <(grep '^  - vless://' "$RAW" || true)

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add all_proxies.yaml clash.yaml
          git commit -m "Update proxies $(date)" || exit 0
          git push

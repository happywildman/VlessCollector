name: Subconverter Filter Optimized

on:
  workflow_dispatch: # Позволяет запускать вручную
  schedule:
    - cron: '0 */6 * * *' # Запуск каждые 6 часов

permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Subconverter
        run: |
          # 1. Получаем URL последней версии через GitHub API для стабильности
          ASSET_URL=$(curl -s https://api.github.com/repos/tindy2013/subconverter/releases/latest | grep "browser_download_url.*linux64.tar.gz" | cut -d '"' -f 4)
          
          if [ -z "$ASSET_URL" ]; then
            echo "Ошибка: Не удалось найти ссылку на скачивание Subconverter"
            exit 1
          fi
          
          echo "Скачивание Subconverter из: $ASSET_URL"
          curl -L -o subconverter.tar.gz "$ASSET_URL"
          
          # 2. Распаковка архива
          tar -xzf subconverter.tar.gz
          echo "Распаковка завершена"

      - name: Generate Clash Config
        run: |
          # 3. Проверка наличия входного файла и конфига
          if [[ ! -f "VlessLinks.txt" ]]; then
            echo "Критическая ошибка: Файл VlessLinks.txt не найден в корне репозитория!"
            exit 1
          fi

          if [[ ! -f "generate.ini" ]]; then
            echo "Критическая ошибка: Файл generate.ini не найден!"
            exit 1
          fi

          # 4. Настройка прав и запуск генерации
          chmod +x ./subconverter/subconverter
          
          # Запуск в режиме генерации (-g)
          # Программа ищет generate.ini в текущей директории
          ./subconverter/subconverter -g
          
          # 5. Верификация результата
          if [[ -f "clash_config.yaml" ]]; then
            echo "Успех: clash_config.yaml создан."
            # Проверка, что файл не пустой и содержит прокси
            NODE_COUNT=$(grep -c "name:" clash_config.yaml || echo "0")
            echo "Найдено узлов в конфиге: $NODE_COUNT"
          else
            echo "Ошибка: Файл clash_config.yaml не был сгенерирован!"
            exit 1
          fi

      - name: Commit and Push
        run: |
          # 6. Настройка Git и пуш изменений
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add clash_config.yaml
          
          # Проверка на наличие реальных изменений, чтобы не спамить в историю коммитов
          if git diff --cached --quiet; then
            echo "Изменений в конфиге нет. Пропуск коммита."
          else
            git commit -m "Update Clash Config: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi

name: VlessCollector Workflow
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Generate Clash.yaml (Full & Clean)
        run: |
          set -e
          python3 <<EOF
import yaml
from urllib.parse import urlparse, parse_qs, unquote

# Загружаем исходные прокси
with open("all_proxies.yaml", "r", encoding="utf-8") as f:
    data = yaml.safe_load(f)

seen = set()
clash_proxies = []

for item in data.get("proxies", []):
    if not isinstance(item, str):
        continue

    url = item.strip()
    if not url.startswith("vless://"):
        continue

    parsed = urlparse(url)
    if not parsed.hostname or not parsed.port:
        continue

    uuid = unquote(parsed.username or "")
    server = parsed.hostname
    port = parsed.port

    if len(uuid) < 6:
        continue

    query = parse_qs(parsed.query)
    network = query.get("type", ["tcp"])[0]
    path = unquote(query.get("path", [""])[0])
    host = unquote(query.get("host", [""])[0])

    key = f"{server}_{port}_{uuid}_{network}"
    if key in seen:
        continue
    seen.add(key)

    proxy = {
        "name": f"{server}-{port}",
        "type": "vless",
        "server": server,
        "port": port,
        "uuid": uuid,
        "network": network,
        "tls": False,
        "udp": True
    }

    if network == "ws":
        ws_opts = {"path": path}
        if host:
            ws_opts["headers"] = {"Host": host}
        proxy["ws-opts"] = ws_opts

    clash_proxies.append(proxy)

with open("clash.yaml", "w", encoding="utf-8") as f:
    yaml.dump(
        {"proxies": clash_proxies},
        f,
        allow_unicode=True,
        sort_keys=False
    )
EOF

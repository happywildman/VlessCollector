name: Subconverter Filter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

# Исправляем ошибку 403: даем права на запись в репозиторий
permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Проверяем исходный файл и фильтруем
        run: |
          echo "Используем исходный файл: VlessLinks.txt"
          # Твоя рабочая очистка: оставляем только vless и reality
          # Добавляем || true, чтобы grep не прерывал работу, если совпадений 0
          grep -iE 'vless://|reality://' VlessLinks.txt > filtered_links.txt || true
          echo "Найдено строк: $(wc -l < filtered_links.txt)"

      - name: Форматирование под Clash (YAML)
        run: |
          # Чтобы Clash не выдавал ошибку 'cannot unmarshal', 
          # создаем структуру proxies: [ 'ссылка1', 'ссылка2' ]
          echo "proxies:" > all_proxies.yaml
          
          # Читаем отфильтрованные ссылки и оборачиваем каждую в кавычки с отступом
          # Это делает файл валидным YAML для Clash Proxy Provider
          while IFS= read -r line; do
            if [ ! -z "$line" ]; then
              echo "  - \"$line\"" >> all_proxies.yaml
            fi
          done < filtered_links.txt
          
          echo "Форматирование завершено. Файл all_proxies.yaml готов."

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all_proxies.yaml
          
          # Проверяем изменения, чтобы не падать на пустом коммите
          if git diff --cached --quiet; then
            echo "Изменений нет, пропускаем push"
          else
            git commit -m "Update proxies: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

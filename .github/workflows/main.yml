name: Subconverter Vless Reality Filtered
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
permissions:
  contents: write

jobs:
  filter_vless_reality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pyyaml

      - name: Install Subconverter
        run: |
          ASSET_URL=$(curl -s https://api.github.com/repos/tindy2013/subconverter/releases/latest \
                      | grep "browser_download_url.*linux64.tar.gz" | cut -d '"' -f 4)
          curl -L -o subconverter.tar.gz "$ASSET_URL"
          tar -xzf subconverter.tar.gz
          chmod +x subconverter/subconverter

      - name: Generate and Clean Vless Reality Nodes
        run: |
          # Проверка VlessLinks.txt
          if [[ ! -f VlessLinks.txt ]]; then
            echo "VlessLinks.txt not found"
            exit 1
          fi

          RAW_URLS=$(grep -v '^#' VlessLinks.txt | grep -v '^$' | tr -d '\r' | tr '\n' '|' | sed 's/|$//')
          if [[ -z "$RAW_URLS" ]]; then
            echo "No URLs found in VlessLinks.txt"
            exit 1
          fi

          # Запуск Subconverter
          ./subconverter/subconverter &

          # Ожидание порта
          TIMEOUT=20
          while ! nc -z 127.0.0.1 25500; do
            sleep 1
            TIMEOUT=$((TIMEOUT-1))
            if [[ $TIMEOUT -le 0 ]]; then
              echo "Subconverter did not start in time"
              exit 1
            fi
          done

          # Получение raw_clash.yaml
          curl -s -G "http://127.0.0.1:25500/sub" \
               --data-urlencode "target=clash" \
               --data-urlencode "url=${RAW_URLS}" \
               --data-urlencode "emoji=true" \
               -o raw_clash.yaml

          if [[ ! -f raw_clash.yaml ]] || [[ ! -s raw_clash.yaml ]]; then
            echo "raw_clash.yaml is empty or missing"
            exit 1
          fi

          # Python-скрипт для фильтрации Reality
          python3 <<'EOF'
          import yaml
          import re

          RAW_FILE = "raw_clash.yaml"
          OUT_FILE = "clash_config.yaml"

          def sanitize_name(name):
              name = re.split(r'[|/@—]', str(name))[0].strip()
              name = re.sub(r'http\S+|www\S+|\.com|\.net|t\.me\S+|@[a-zA-Z0-9_]+', '', name, flags=re.IGNORECASE)
              name = "".join(c for c in name if c.isalnum() or c in " .-_()").strip()
              return name if len(name) > 1 else "Vless-Server"

          with open(RAW_FILE, 'r', encoding='utf-8', errors='ignore') as f:
              data = yaml.safe_load(f)

          proxies = data.get('proxies', [])
          cleaned_proxies = []
          proxy_names = set()

          for proxy in proxies:
              # Только Vless Reality узлы с обязательными параметрами
              if proxy.get('type','').lower() == 'vless' and proxy.get('server') and proxy.get('port'):
                  # Проверка UUID/ID для Reality
                  if proxy.get('uuid') or proxy.get('id') or proxy.get('flow') or proxy.get('ws-path'):
                      old_name = proxy.get('name','Vless-Server')
                      new_name = sanitize_name(old_name)

                      final_name = new_name
                      count = 1
                      while final_name in proxy_names:
                          final_name = f"{new_name}-{count}"
                          count += 1

                      proxy['name'] = final_name
                      cleaned_proxies.append(proxy)
                      proxy_names.add(final_name)

          final_yaml = {
              'proxies': cleaned_proxies,
              'proxy-groups': [
                  {
                      'name': 'PROXY',
                      'type': 'select',
                      'proxies': list(proxy_names) if proxy_names else ['DIRECT']
                  }
              ],
              'rules': ['MATCH,PROXY']
          }

          with open(OUT_FILE, 'w', encoding='utf-8') as f:
              yaml.safe_dump(final_yaml, f, allow_unicode=True, sort_keys=False)

          print(f"Extraction complete: {len(cleaned_proxies)} Reality nodes found.")
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [[ -f "clash_config.yaml" ]]; then
            git add clash_config.yaml
            git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Vless Reality $(date +%H:%M)" && git push)

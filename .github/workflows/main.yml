      - name: Traffic test with Xray - create traff.yaml
        run: |
          set -e
          echo "Starting TRAFFIC TEST with Xray at $(date)"
          
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip -d xray/
          chmod +x xray/xray
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Xray Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
          echo "ðŸ” Checking Xray version..."
          ./xray/xray version || echo "âš ï¸ Xray version check failed"
          
          # Python-ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
          echo 'import json, sys, urllib.parse' > /tmp/gen_xray_config.py
          echo 'url = sys.argv[1]' >> /tmp/gen_xray_config.py
          echo 'local_port = int(sys.argv[2])' >> /tmp/gen_xray_config.py
          echo 'try:' >> /tmp/gen_xray_config.py
          echo '    parsed = urllib.parse.urlparse(url.replace("vless://", "http://"))' >> /tmp/gen_xray_config.py
          echo '    auth, server_port = parsed.netloc.split("@", 1)' >> /tmp/gen_xray_config.py
          echo '    server, port = server_port.rsplit(":", 1)' >> /tmp/gen_xray_config.py
          echo '    uuid = urllib.parse.unquote(auth)' >> /tmp/gen_xray_config.py
          echo '    params = dict(urllib.parse.parse_qsl(parsed.query))' >> /tmp/gen_xray_config.py
          echo '    network = params.get("type", "tcp")' >> /tmp/gen_xray_config.py
          echo '    security = params.get("security", "none")' >> /tmp/gen_xray_config.py
          echo '    sni = params.get("sni", server if security in ["tls", "reality"] else "")' >> /tmp/gen_xray_config.py
          echo '    flow = params.get("flow", "")' >> /tmp/gen_xray_config.py
          echo '    host = params.get("host", "")' >> /tmp/gen_xray_config.py
          echo '    path = params.get("path", "")' >> /tmp/gen_xray_config.py
          echo '    user = {"id": uuid}' >> /tmp/gen_xray_config.py
          echo '    if flow: user["flow"] = flow' >> /tmp/gen_xray_config.py
          echo '    outbound_settings = {"vnext": [{"address": server, "port": int(port), "users": [user]}]}' >> /tmp/gen_xray_config.py
          echo '    stream_settings = {"network": network, "security": security}' >> /tmp/gen_xray_config.py
          echo '    if security == "tls":' >> /tmp/gen_xray_config.py
          echo '        stream_settings["tlsSettings"] = {"serverName": sni if sni else server, "allowInsecure": True}' >> /tmp/gen_xray_config.py
          echo '    elif security == "reality":' >> /tmp/gen_xray_config.py
          echo '        stream_settings["realitySettings"] = {"serverName": sni if sni else server, "allowInsecure": True}' >> /tmp/gen_xray_config.py
          echo '    if network == "ws" and (path or host):' >> /tmp/gen_xray_config.py
          echo '        ws_settings = {}' >> /tmp/gen_xray_config.py
          echo '        if path: ws_settings["path"] = path' >> /tmp/gen_xray_config.py
          echo '        if host: ws_settings["headers"] = {"Host": host}' >> /tmp/gen_xray_config.py
          echo '        stream_settings["wsSettings"] = ws_settings' >> /tmp/gen_xray_config.py
          echo '    config = {' >> /tmp/gen_xray_config.py
          echo '        "log": {"loglevel": "warning"},' >> /tmp/gen_xray_config.py
          echo '        "inbounds": [{"port": local_port, "protocol": "socks", "settings": {"auth": "noauth", "udp": True}}],' >> /tmp/gen_xray_config.py
          echo '        "outbounds": [{"protocol": "vless", "settings": outbound_settings, "streamSettings": stream_settings}]' >> /tmp/gen_xray_config.py
          echo '    }' >> /tmp/gen_xray_config.py
          echo '    print(json.dumps(config, indent=2))' >> /tmp/gen_xray_config.py
          echo 'except Exception as e:' >> /tmp/gen_xray_config.py
          echo '    print(json.dumps({"error": str(e)}), file=sys.stderr)' >> /tmp/gen_xray_config.py
          echo '    sys.exit(1)' >> /tmp/gen_xray_config.py
          
          echo "proxies:" > traff.yaml
          mkdir -p /tmp/xray_results
          rm -f /tmp/xray_results/*
          mkdir -p /tmp/xray_logs
          rm -f /tmp/xray_logs/*
          > /tmp/xray_queue.txt
          
          total=0
          valid_configs=0
          
          # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 Ð¿Ñ€Ð¾ÐºÑÐ¸ Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ Ð»Ð¾Ð³Ð¾Ð¼
          MAX_DEBUG=10
          
          while IFS= read -r line || [ -n "$line" ]; do
            [[ "$line" == "proxies:" ]] && continue
            [[ -z "$line" ]] && continue
            
            url="${line#  - }"
            total=$((total + 1))
            
            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ðµ MAX_DEBUG Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ Ð»Ð¾Ð³Ð¾Ð¼
            if [[ $total -gt $MAX_DEBUG ]] && [[ $valid_configs -ge 2 ]]; then
              break
            fi
            
            local_port=$((10000 + total))
            config_file="/tmp/xray_config_${total}.json"
            
            python3 /tmp/gen_xray_config.py "$url" "$local_port" > "$config_file" 2>/tmp/xray_logs/py_err_${total}.txt
            
            if ! jq -e '.' "$config_file" >/dev/null 2>&1; then
              echo "âš ï¸ Proxy #$total: Invalid JSON config" >&2
              continue
            fi
            
            valid_configs=$((valid_configs + 1))
            echo "$total|$local_port|$config_file|$url" >> /tmp/xray_queue.txt
            
          done < ping.yaml
          
          echo ""
          echo "ðŸ“‹ Prepared $valid_configs valid configs for testing (from $total total)"
          echo "ðŸ”„ Starting parallel Xray test (5 at a time)..."
          echo ""
          
          test_xray_proxy() {
            local item="$1"
            local idx=$(echo "$item" | cut -d'|' -f1)
            local local_port=$(echo "$item" | cut -d'|' -f2)
            local config_file=$(echo "$item" | cut -d'|' -f3)
            local url=$(echo "$item" | cut -d'|' -f4-)
            
            local log_file="/tmp/xray_logs/xray_${idx}.log"
            local result_file="/tmp/xray_results/result_${idx}.txt"
            
            echo "ðŸ” Testing proxy #$idx..."
            echo "   URL: ${url:0:80}..."
            echo "   Port: $local_port"
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Xray
            ./xray/xray -config "$config_file" > "$log_file" 2>&1 &
            XRAY_PID=$!
            
            # Ð–Ð´Ñ‘Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
            local port_ready=0
            for i in {1..20}; do
              if ! kill -0 $XRAY_PID 2>/dev/null; then
                echo "   âŒ Xray process died" >&2
                break
              fi
              if nc -z 127.0.0.1 "$local_port" 2>/dev/null; then
                port_ready=1
                break
              fi
              sleep 0.2
            done
            
            if [[ $port_ready -eq 1 ]]; then
              echo "   âœ“ Xray port open, testing connection..."
              
              http_code=$(curl -s -o /dev/null -w "%{http_code}" \
                --socks5-hostname 127.0.0.1:"$local_port" \
                --connect-timeout 3 --max-time 5 \
                "http://www.gstatic.com/generate_204" 2>/dev/null) || http_code="000"
              
              echo "   ðŸ“¡ HTTP code: $http_code"
              
              if [[ "$http_code" == "204" ]]; then
                echo "$url" >> "$result_file"
                echo "   âœ… PASSED"
              else
                echo "   âŒ FAILED (HTTP $http_code)"
                echo "   ðŸ“„ Xray log (last 5 lines):"
                tail -5 "$log_file" | sed 's/^/      /' >&2
              fi
            else
              echo "   âŒ Port never opened"
              echo "   ðŸ“„ Xray log:"
              cat "$log_file" | sed 's/^/      /' >&2
            fi
            
            kill $XRAY_PID 2>/dev/null || true
            wait $XRAY_PID 2>/dev/null || true
            
            echo ""
          }
          
          export -f test_xray_proxy
          
          cat /tmp/xray_queue.txt | xargs -P 5 -I {} bash -c 'test_xray_proxy "{}"'
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          if [ -d /tmp/xray_results ]; then
            cat /tmp/xray_results/*.txt >> traff.yaml 2>/dev/null || true
          fi
          
          passed=$(grep -c '^-' traff.yaml 2>/dev/null) || true
          passed=${passed:-0}
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "=== TRAFFIC TEST RESULTS ==="
          echo "Total tested: $valid_configs"
          echo "âœ… Passed traffic: $passed"
          echo "âŒ Failed traffic: $((valid_configs - passed))"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ²Ð¾Ð´ÐºÑƒ Ð¿Ð¾ Ð»Ð¾Ð³Ð°Ð¼
          echo ""
          echo "ðŸ“„ Common Xray errors:"
          grep -h "Error\|Failed\|error" /tmp/xray_logs/*.log 2>/dev/null | sort | uniq -c | sort -rn | head -5 || echo "   (no errors found)"
